<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantraPay DAO Governance</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 2.5em;
        }

        .wallet-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn.warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }

        .btn.danger {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .wallet-info {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            color: #333;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            gap: 10px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }

        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .content-section.active {
            display: block;
        }

        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .metric {
            text-align: center;
            padding: 20px;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
        }

        .proposal-card {
            border-left: 4px solid #1e3c72;
            margin-bottom: 15px;
        }

        .proposal-card.active {
            border-left-color: #28a745;
        }

        .proposal-card.executed {
            border-left-color: #17a2b8;
        }

        .proposal-card.rejected {
            border-left-color: #dc3545;
        }

        .proposal-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .proposal-title {
            font-weight: 600;
            color: #1e3c72;
            flex: 1;
        }

        .proposal-type {
            background: #e9ecef;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .vote-progress {
            margin: 15px 0;
        }

        .vote-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .vote-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .vote-for {
            background: #28a745;
        }

        .vote-against {
            background: #dc3545;
        }

        .vote-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status.active {
            background: #d4edda;
            color: #155724;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status.executed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .member-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .member-status.inactive {
            color: #dc3545;
        }

        .member-status.active {
            color: #28a745;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3c72;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .region-card {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .parameter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e1e5e9;
        }

        .emergency-alert {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .wallet-section {
                flex-direction: column;
                align-items: stretch;
            }

            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }

            .proposal-header {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>QuantraPay DAO Governance</h1>
            <div class="wallet-section">
                <button id="connectWallet" class="btn">Connect Wallet</button>
                <div id="walletInfo" class="wallet-info" style="display: none;"></div>
                <div id="memberStatus" class="member-status" style="display: none;"></div>
                <button id="activateMember" class="btn success" style="display: none;">Activate Membership</button>
                <button id="disconnectWallet" class="btn" style="display: none;">Disconnect</button>
            </div>
            <div id="alertContainer"></div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="overview">Overview</button>
                <button class="nav-tab" data-section="proposals">Proposals</button>
                <button class="nav-tab" data-section="voting">Voting</button>
                <button class="nav-tab" data-section="regions">Regions</button>
                <button class="nav-tab" data-section="parameters">Parameters</button>
                <button class="nav-tab" data-section="emergency">Emergency</button>
                <button class="nav-tab" data-section="analytics">Analytics</button>
            </div>

            <!-- Overview Section -->
            <div id="overview" class="content-section active">
                <h2>DAO Overview</h2>
                <div class="grid grid-4">
                    <div class="card metric">
                        <div class="metric-value" id="totalProposals">0</div>
                        <div class="metric-label">Total Proposals</div>
                    </div>
                    <div class="card metric">
                        <div class="metric-value" id="activeProposals">0</div>
                        <div class="metric-label">Active Proposals</div>
                    </div>
                    <div class="card metric">
                        <div class="metric-value" id="totalMembers">0</div>
                        <div class="metric-label">Total Members</div>
                    </div>
                    <div class="card metric">
                        <div class="metric-value" id="participation">0%</div>
                        <div class="metric-label">Participation Rate</div>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="card">
                        <h3>Recent Proposals</h3>
                        <div id="recentProposals">
                            <div class="loading">
                                <div class="spinner"></div>
                                Loading proposals...
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Active Regions</h3>
                        <div id="activeRegions">
                            <div class="loading">
                                <div class="spinner"></div>
                                Loading regions...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Proposals Section -->
            <div id="proposals" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Proposal Management</h2>
                    <button class="btn success" onclick="showCreateProposalModal()">Create Proposal</button>
                </div>
                
                <div class="card">
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="proposalStatusFilter" class="form-control" style="width: auto;">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="executed">Executed</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <select id="proposalTypeFilter" class="form-control" style="width: auto;">
                            <option value="">All Types</option>
                            <option value="parameter">Parameter</option>
                            <option value="region">Region</option>
                            <option value="emergency">Emergency</option>
                            <option value="general">General</option>
                        </select>
                        <button class="btn" onclick="loadProposals()">Filter</button>
                    </div>
                    <div id="proposalsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading proposals...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Voting Section -->
            <div id="voting" class="content-section">
                <h2>Active Voting</h2>
                <div id="votingProposals">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading voting opportunities...
                    </div>
                </div>
            </div>

            <!-- Regions Section -->
            <div id="regions" class="content-section">
                <h2>Region Management</h2>
                <div id="regionsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading regions...
                    </div>
                </div>
            </div>

            <!-- Parameters Section -->
            <div id="parameters" class="content-section">
                <h2>System Parameters</h2>
                <div class="card">
                    <div id="parametersList">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading parameters...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Section -->
            <div id="emergency" class="content-section">
                <h2>Emergency Actions</h2>
                <div class="emergency-alert">
                    <strong>⚠️ Emergency Controls</strong><br>
                    Use emergency actions only in critical situations. All emergency actions are logged and subject to review.
                </div>
                
                <div class="grid grid-2">
                    <div class="card">
                        <h3>Create Emergency Action</h3>
                        <form id="emergencyForm">
                            <div class="form-group">
                                <label>Action Type</label>
                                <select class="form-control" name="action" required>
                                    <option value="">Select Action</option>
                                    <option value="pause_system">Pause System</option>
                                    <option value="freeze_assets">Freeze Assets</option>
                                    <option value="emergency_withdrawal">Emergency Withdrawal</option>
                                    <option value="blacklist_address">Blacklist Address</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Severity Level</label>
                                <select class="form-control" name="severity" required>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Reason</label>
                                <textarea class="form-control" name="reason" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn danger">Execute Emergency Action</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3>Recent Emergency Actions</h3>
                        <div id="emergencyActions">
                            <div class="loading">
                                <div class="spinner"></div>
                                Loading emergency actions...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics" class="content-section">
                <h2>DAO Analytics</h2>
                <div class="card">
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <select id="analyticsPeriod" class="form-control" style="width: auto;">
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                        </select>
                        <button class="btn" onclick="loadAnalytics()">Update</button>
                    </div>
                    <canvas id="participationChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Create Proposal Modal -->
        <div id="createProposalModal" class="modal">
            <div class="modal-content">
                <h3>Create New Proposal</h3>
                <form id="createProposalForm">
                    <div class="form-group">
                        <label>Proposal Title</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="form-group">
                        <label>Proposal Type</label>
                        <select class="form-control" name="type" required>
                            <option value="">Select Type</option>
                            <option value="parameter">Parameter Change</option>
                            <option value="region">Region Management</option>
                            <option value="emergency">Emergency Action</option>
                            <option value="general">General Proposal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" name="description" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Voting Period (days)</label>
                        <input type="number" class="form-control" name="votingPeriod" min="1" max="30" value="3" required>
                    </div>
                    <div id="proposalDetails" style="display: none;">
                        <div class="form-group">
                            <label>Implementation Details (JSON)</label>
                            <textarea class="form-control" name="details" rows="3" placeholder='{"parameterKey": "value", "newValue": "newValue"}'></textarea>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="hideCreateProposalModal()">Cancel</button>
                        <button type="submit" class="btn success">Create Proposal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Vote Modal -->
        <div id="voteModal" class="modal">
            <div class="modal-content">
                <h3>Cast Your Vote</h3>
                <div id="voteProposalDetails"></div>
                <form id="voteForm">
                    <input type="hidden" name="proposalId">
                    <div class="form-group">
                        <label>Your Vote</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label><input type="radio" name="support" value="for" required> For</label>
                            <label><input type="radio" name="support" value="against" required> Against</label>
                            <label><input type="radio" name="support" value="abstain" required> Abstain</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Reason (Optional)</label>
                        <textarea class="form-control" name="reason" rows="3"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="hideVoteModal()">Cancel</button>
                        <button type="submit" class="btn success">Cast Vote</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentAccount = null;
        let authToken = null;
        let memberData = null;
        let participationChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkWalletConnection();
        });

        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);
            document.getElementById('activateMember').addEventListener('click', activateMembership);
            
            // Navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchSection(e.target.dataset.section));
            });

            // Forms
            document.getElementById('createProposalForm').addEventListener('submit', handleCreateProposal);
            document.getElementById('voteForm').addEventListener('submit', handleVote);
            document.getElementById('emergencyForm').addEventListener('submit', handleEmergencyAction);
            
            // Proposal type change
            document.querySelector('select[name="type"]').addEventListener('change', (e) => {
                const detailsDiv = document.getElementById('proposalDetails');
                detailsDiv.style.display = ['parameter', 'region'].includes(e.target.value) ? 'block' : 'none';
            });
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showAlert('MetaMask is not installed!', 'error');
                    return;
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0];

                // Sign message for authentication
                const message = `Welcome to QuantraPay DAO Governance!\n\nPlease sign this message to authenticate your membership.\n\nTimestamp: ${Date.now()}`;
                const signature = await window.ethereum.request({
                    method: 'personal_sign',
                    params: [message, currentAccount]
                });

                // Authenticate with backend
                const response = await fetch('/api/auth/connect-wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        walletAddress: currentAccount,
                        signature: signature,
                        message: message
                    })
                });

                const data = await response.json();
                if (data.success) {
                    authToken = data.token;
                    memberData = data.member;
                    updateWalletUI();
                    showDashboard();
                    loadDashboardData();
                } else {
                    showAlert('Failed to connect wallet: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Wallet connection error:', error);
                showAlert('Failed to connect wallet', 'error');
            }
        }

        function disconnectWallet() {
            currentAccount = null;
            authToken = null;
            memberData = null;
            updateWalletUI();
            hideDashboard();
        }

        function updateWalletUI() {
            const connectBtn = document.getElementById('connectWallet');
            const disconnectBtn = document.getElementById('disconnectWallet');
            const walletInfo = document.getElementById('walletInfo');
            const memberStatus = document.getElementById('memberStatus');
            const activateBtn = document.getElementById('activateMember');

            if (currentAccount) {
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-block';
                walletInfo.style.display = 'inline-block';
                walletInfo.textContent = `Connected: ${currentAccount.substring(0, 6)}...${currentAccount.substring(38)}`;
                
                if (memberData) {
                    memberStatus.style.display = 'inline-block';
                    memberStatus.className = `member-status ${memberData.isActive ? 'active' : 'inactive'}`;
                    memberStatus.innerHTML = `
                        <span>${memberData.isActive ? '✓' : '⚠'}</span>
                        <span>Member Status: ${memberData.isActive ? 'Active' : 'Inactive'}</span>
                        <span>Voting Power: ${memberData.votingPower || 0}</span>
                    `;
                    
                    activateBtn.style.display = memberData.isActive ? 'none' : 'inline-block';
                }
            } else {
                connectBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'none';
                walletInfo.style.display = 'none';
                memberStatus.style.display = 'none';
                activateBtn.style.display = 'none';
            }
        }

        async function activateMembership() {
            try {
                const response = await fetch('/api/dao/members/activate', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (data.success) {
                    memberData = data.member;
                    updateWalletUI();
                    showAlert('Membership activated successfully!', 'success');
                    loadDashboardData();
                } else {
                    showAlert('Failed to activate membership: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Membership activation error:', error);
                showAlert('Failed to activate membership', 'error');
            }
        }

        function showDashboard() {
            document.getElementById('dashboard').classList.add('active');
        }

        function hideDashboard() {
            document.getElementById('dashboard').classList.remove('active');
        }

        function switchSection(sectionId) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

            // Update content sections
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            // Load section-specific data
            switch(sectionId) {
                case 'overview':
                    loadDashboardData();
                    break;
                case 'proposals':
                    loadProposals();
                    break;
                case 'voting':
                    loadVotingProposals();
                    break;
                case 'regions':
                    loadRegions();
                    break;
                case 'parameters':
                    loadParameters();
                    break;
                case 'emergency':
                    loadEmergencyActions();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
            }
        }

        async function loadDashboardData() {
            try {
                // Load analytics for overview
                const analyticsResponse = await fetch('/api/dao/analytics?period=30d', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const analyticsData = await analyticsResponse.json();
                
                if (analyticsData.success) {
                    const analytics = analyticsData.analytics;
                    document.getElementById('totalProposals').textContent = analytics.totalProposals;
                    document.getElementById('activeProposals').textContent = analytics.activeProposals;
                    document.getElementById('totalMembers').textContent = analytics.totalMembers;
                    document.getElementById('participation').textContent = `${analytics.averageParticipation}%`;
                }

                // Load recent proposals
                const proposalsResponse = await fetch('/api/dao/proposals?limit=5', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const proposalsData = await proposalsResponse.json();
                
                if (proposalsData.success) {
                    displayRecentProposals(proposalsData.proposals);
                }

                // Load regions
                const regionsResponse = await fetch('/api/dao/regions', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const regionsData = await regionsResponse.json();
                
                if (regionsData.success) {
                    displayActiveRegions(regionsData.regions);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function displayRecentProposals(proposals) {
            const container = document.getElementById('recentProposals');
            
            if (proposals.length === 0) {
                container.innerHTML = '<p>No recent proposals</p>';
                return;
            }

            const html = proposals.map(proposal => `
                <div class="proposal-card ${proposal.status}">
                    <div class="proposal-header">
                        <div class="proposal-title">${proposal.title}</div>
                        <div class="proposal-type">${proposal.type}</div>
                    </div>
                    <p style="color: #666; margin-bottom: 10px;">${proposal.description.substring(0, 100)}...</p>
                    <div class="vote-progress">
                        <div class="vote-bar">
                            <div class="vote-bar-fill vote-for" style="width: ${getVotePercentage(proposal.forVotes, proposal.totalVotes)}%"></div>
                        </div>
                        <div class="vote-stats">
                            <span>For: ${proposal.forVotes}</span>
                            <span>Against: ${proposal.againstVotes}</span>
                            <span>Total: ${proposal.totalVotes}</span>
                        </div>
                    </div>
                    <div style="font-size: 0.9em; color: #666;">
                        Expires: ${new Date(proposal.expiresAt).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function displayActiveRegions(regions) {
            const container = document.getElementById('activeRegions');
            
            const activeRegions = regions.filter(region => region.status === 'active');
            
            if (activeRegions.length === 0) {
                container.innerHTML = '<p>No active regions</p>';
                return;
            }

            const html = activeRegions.map(region => `
                <div class="region-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${region.name}</strong>
                            <div style="font-size: 0.9em; color: #666;">${region.id}</div>
                        </div>
                        <span class="status ${region.status}">${region.status}</span>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        async function loadProposals() {
            try {
                const status = document.getElementById('proposalStatusFilter').value;
                const type = document.getElementById('proposalTypeFilter').value;
                
                const params = new URLSearchParams();
                if (status) params.append('status', status);
                if (type) params.append('type', type);
                
                const response = await fetch(`/api/dao/proposals?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayProposals(data.proposals);
                }
            } catch (error) {
                console.error('Error loading proposals:', error);
            }
        }

        function displayProposals(proposals) {
            const container = document.getElementById('proposalsList');
            
            if (proposals.length === 0) {
                container.innerHTML = '<p>No proposals found</p>';
                return;
            }

            const html = proposals.map(proposal => `
                <div class="proposal-card ${proposal.status}">
                    <div class="proposal-header">
                        <div class="proposal-title">${proposal.title}</div>
                        <div class="proposal-type">${proposal.type}</div>
                    </div>
                    <p style="margin-bottom: 15px;">${proposal.description}</p>
                    <div class="vote-progress">
                        <div class="vote-bar">
                            <div class="vote-bar-fill vote-for" style="width: ${getVotePercentage(proposal.forVotes, proposal.totalVotes)}%"></div>
                        </div>
                        <div class="vote-stats">
                            <span>For: ${proposal.forVotes}</span>
                            <span>Against: ${proposal.againstVotes}</span>
                            <span>Abstain: ${proposal.abstainVotes}</span>
                            <span>Total: ${proposal.totalVotes}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <div style="font-size: 0.9em; color: #666;">
                            <div>Created: ${new Date(proposal.createdAt).toLocaleDateString()}</div>
                            <div>Expires: ${new Date(proposal.expiresAt).toLocaleDateString()}</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            ${proposal.status === 'active' && !proposal.voters.includes(currentAccount) && memberData?.isActive ? 
                                `<button class="btn success" onclick="showVoteModal('${proposal.id}')">Vote</button>` : ''}
                            ${proposal.status === 'active' && new Date() > new Date(proposal.expiresAt) && !proposal.executed ? 
                                `<button class="btn warning" onclick="executeProposal('${proposal.id}')">Execute</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        async function loadVotingProposals() {
            try {
                const response = await fetch('/api/dao/proposals?status=active', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const votableProposals = data.proposals.filter(p => 
                        !p.voters.includes(currentAccount) && new Date() < new Date(p.expiresAt)
                    );
                    displayVotingProposals(votableProposals);
                }
            } catch (error) {
                console.error('Error loading voting proposals:', error);
            }
        }

        function displayVotingProposals(proposals) {
            const container = document.getElementById('votingProposals');
            
            if (proposals.length === 0) {
                container.innerHTML = '<div class="card"><p>No active proposals available for voting</p></div>';
                return;
            }

            const html = proposals.map(proposal => `
                <div class="proposal-card active">
                    <div class="proposal-header">
                        <div class="proposal-title">${proposal.title}</div>
                        <div class="proposal-type">${proposal.type}</div>
                    </div>
                    <p style="margin-bottom: 15px;">${proposal.description}</p>
                    <div class="vote-progress">
                        <div class="vote-bar">
                            <div class="vote-bar-fill vote-for" style="width: ${getVotePercentage(proposal.forVotes, proposal.totalVotes)}%"></div>
                        </div>
                        <div class="vote-stats">
                            <span>For: ${proposal.forVotes}</span>
                            <span>Against: ${proposal.againstVotes}</span>
                            <span>Total Votes: ${proposal.totalVotes}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <div style="font-size: 0.9em; color: #666;">
                            Time Remaining: ${getTimeRemaining(proposal.expiresAt)}
                        </div>
                        <button class="btn success" onclick="showVoteModal('${proposal.id}')">Cast Vote</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        async function loadRegions() {
            try {
                const response = await fetch('/api/dao/regions', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayRegions(data.regions);
                }
            } catch (error) {
                console.error('Error loading regions:', error);
            }
        }

        function displayRegions(regions) {
            const container = document.getElementById('regionsList');
            
            const html = regions.map(region => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3>${region.name} (${region.id})</h3>
                            <p>Status: <span class="status ${region.status}">${region.status}</span></p>
                            ${region.manager ? `<p>Manager: ${region.manager}</p>` : ''}
                            ${region.lastUpdated ? `<p>Last Updated: ${new Date(region.lastUpdated).toLocaleDateString()}</p>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        async function loadParameters() {
            try {
                const response = await fetch('/api/dao/parameters', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayParameters(data.parameters);
                }
            } catch (error) {
                console.error('Error loading parameters:', error);
            }
        }

        function displayParameters(parameters) {
            const container = document.getElementById('parametersList');
            
            const html = parameters.map(param => `
                <div class="parameter-item">
                    <div>
                        <strong>${param.key}</strong>
                        <div style="font-size: 0.9em; color: #666;">${param.description}</div>
                        ${param.lastUpdated ? `<div style="font-size: 0.8em; color: #999;">Updated: ${new Date(param.lastUpdated).toLocaleDateString()}</div>` : ''}
                    </div>
                    <div style="font-family: monospace; font-weight: bold;">
                        ${param.value}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        async function loadEmergencyActions() {
            try {
                const response = await fetch('/api/dao/emergency', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayEmergencyActions(data.emergencyActions);
                }
            } catch (error) {
                console.error('Error loading emergency actions:', error);
            }
        }

        function displayEmergencyActions(actions) {
            const container = document.getElementById('emergencyActions');
            
            if (actions.length === 0) {
                container.innerHTML = '<p>No recent emergency actions</p>';
                return;
            }

            const html = actions.slice(0, 5).map(action => `
                <div style="border-left: 4px solid ${getSeverityColor(action.severity)}; padding: 10px; margin-bottom: 10px; background: #f8f9fa;">
                    <div style="font-weight: 600;">${action.action}</div>
                    <div style="font-size: 0.9em; color: #666; margin: 5px 0;">${action.reason}</div>
                    <div style="font-size: 0.8em; color: #999;">
                        Severity: ${action.severity} | ${new Date(action.initiatedAt).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        async function loadAnalytics() {
            try {
                const period = document.getElementById('analyticsPeriod').value;
                const response = await fetch(`/api/dao/analytics?period=${period}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayAnalyticsChart(data.analytics);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function displayAnalyticsChart(analytics) {
            const ctx = document.getElementById('participationChart').getContext('2d');
            
            if (participationChart) {
                participationChart.destroy();
            }

            participationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: analytics.participationData.map(d => d.date),
                    datasets: [{
                        label: 'Proposals',
                        data: analytics.participationData.map(d => d.proposals),
                        borderColor: '#1e3c72',
                        backgroundColor: 'rgba(30, 60, 114, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Votes Cast',
                        data: analytics.participationData.map(d => d.votes),
                        borderColor: '#2a5298',
                        backgroundColor: 'rgba(42, 82, 152, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Participation %',
                        data: analytics.participationData.map(d => d.participation),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Participation %'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'DAO Participation Analytics'
                        }
                    }
                }
            });
        }

        // Modal functions
        function showCreateProposalModal() {
            if (!memberData?.isActive) {
                showAlert('Active membership required to create proposals', 'warning');
                return;
            }
            document.getElementById('createProposalModal').style.display = 'block';
        }

        function hideCreateProposalModal() {
            document.getElementById('createProposalModal').style.display = 'none';
            document.getElementById('createProposalForm').reset();
        }

        function showVoteModal(proposalId) {
            if (!memberData?.isActive) {
                showAlert('Active membership required to vote', 'warning');
                return;
            }
            
            document.querySelector('input[name="proposalId"]').value = proposalId;
            document.getElementById('voteModal').style.display = 'block';
        }

        function hideVoteModal() {
            document.getElementById('voteModal').style.display = 'none';
            document.getElementById('voteForm').reset();
        }

        // Form handlers
        async function handleCreateProposal(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const proposalData = Object.fromEntries(formData);
            
            // Parse details if provided
            if (proposalData.details) {
                try {
                    proposalData.details = JSON.parse(proposalData.details);
                } catch (error) {
                    showAlert('Invalid JSON in implementation details', 'error');
                    return;
                }
            }

            try {
                const response = await fetch('/api/dao/proposals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(proposalData)
                });

                const data = await response.json();
                if (data.success) {
                    hideCreateProposalModal();
                    showAlert('Proposal created successfully!', 'success');
                    loadProposals();
                } else {
                    showAlert('Failed to create proposal: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Proposal creation error:', error);
                showAlert('Failed to create proposal', 'error');
            }
        }

        async function handleVote(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const voteData = Object.fromEntries(formData);

            try {
                const response = await fetch(`/api/dao/proposals/${voteData.proposalId}/vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        support: voteData.support,
                        reason: voteData.reason
                    })
                });

                const data = await response.json();
                if (data.success) {
                    hideVoteModal();
                    showAlert('Vote cast successfully!', 'success');
                    loadProposals();
                    loadVotingProposals();
                } else {
                    showAlert('Failed to cast vote: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Voting error:', error);
                showAlert('Failed to cast vote', 'error');
            }
        }

        async function handleEmergencyAction(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const actionData = Object.fromEntries(formData);

            if (!confirm('Are you sure you want to execute this emergency action? This action will be logged and reviewed.')) {
                return;
            }

            try {
                const response = await fetch('/api/dao/emergency', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(actionData)
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('Emergency action executed successfully!', 'success');
                    loadEmergencyActions();
                    e.target.reset();
                } else {
                    showAlert('Failed to execute emergency action: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Emergency action error:', error);
                showAlert('Failed to execute emergency action', 'error');
            }
        }

        async function executeProposal(proposalId) {
            if (!confirm('Are you sure you want to execute this proposal?')) {
                return;
            }

            try {
                const response = await fetch(`/api/dao/proposals/${proposalId}/execute`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (data.success) {
                    showAlert(`Proposal ${data.result}!`, 'success');
                    loadProposals();
                } else {
                    showAlert('Failed to execute proposal: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Proposal execution error:', error);
                showAlert('Failed to execute proposal', 'error');
            }
        }

        // Utility functions
        function getVotePercentage(votes, total) {
            return total > 0 ? Math.round((votes / total) * 100) : 0;
        }

        function getTimeRemaining(expirationDate) {
            const now = new Date();
            const expires = new Date(expirationDate);
            const diff = expires - now;
            
            if (diff <= 0) return 'Expired';
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) return `${days} days`;
            return `${hours} hours`;
        }

        function getSeverityColor(severity) {
            const colors = {
                low: '#28a745',
                medium: '#ffc107',
                high: '#fd7e14',
                critical: '#dc3545'
            };
            return colors[severity] || '#666';
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        currentAccount = accounts[0];
                        updateWalletUI();
                    }
                } catch (error) {
                    console.error('Error checking wallet connection:', error);
                }
            }
        }
    </script>
</body>
</html>